# Auth UI for sertantai-hub

**Started**: 2026-02-18
**Plan**: `.claude/plans/auth-ui.md`
**Project**: `~/Desktop/sertantai-hub`

---

## Phase 1: Port Allocations

### Current Reality (audited 2026-02-19)

Ports as actually configured in each repo's code/config:

| Service | PostgreSQL | Electric | Backend (dev) | Frontend |
|---------|------------|----------|---------------|----------|
| **auth** | default (5432 local, 5435 docker) | — | 4000 (dev.exs) / 4001 (docker) | — (no frontend) |
| **hub** | 5435 | 3000 | 4006 (dev.exs) / 4000 (docker) | 5173 |
| **controls** | 5435 | 3000 | 4001 | 5173 |
| **enforcement** | 5434 | 3001 | 4002 | 5173 |
| **legal** | 5436 | 3002 | 4003 | 5175 |

Source files per service:

**auth** (`~/Desktop/sertantai-auth`):
- `config/dev.exs:22` — backend port 4000 (localhost only, no explicit pg port = default 5432)
- `docker-compose.dev.yml` — pg 5435:5432, app 4001:4001 (integration testing only, see below)
- No Electric, no frontend

> **Auth dev model differs from other services.** Auth is a pure backend API — no
> ElectricSQL, no frontend. In daily dev you run `mix phx.server` directly against
> native localhost PostgreSQL (port 5432). No Docker infrastructure needed.
>
> Auth's `docker-compose.dev.yml` serves a different purpose: running the **pre-built
> release image** (`ghcr.io/shotleybuilder/sertantai-auth:latest`) for integration
> testing — simulating how other services talk to auth in production. This is why it
> uses `sertantai_auth_prod` as the DB name and port 4001 (the prod/runtime default),
> not the dev database or dev port.
>
> The other services (hub, legal, controls, enforcement) all need Docker for
> **infrastructure** (Postgres + Electric) because ElectricSQL must run alongside.
> Auth doesn't have that dependency, so Docker is optional.
>
> **Conflict implications**: Auth's docker pg port 5435 only conflicts with hub/controls
> if you run the auth integration container at the same time as their dev infrastructure.
> In normal dev this doesn't happen — but we fix it anyway (→5438) for correctness.

**hub** (`~/Desktop/sertantai-hub`):
- `backend/config/dev.exs:32` — backend port 4006 (already changed from 4000)
- `docker-compose.dev.yml` — pg 5435:5432, electric 3000:3000, backend 4000:4000, frontend 5173:5173
- `frontend/vite.config.ts:8` — port 5173
- `frontend/.env.development` — `VITE_API_URL=http://localhost:4000` (stale, should be 4006)

**controls** (`~/Desktop/sertantai-controls`):
- `backend/config/dev.exs:43` — backend port 4001 (via `SERTANTAI_CONTROLS_PORT` env or default)
- `backend/config/dev.exs:18` — pg port 5435 (fallback config)
- `docker-compose.dev.yml` — pg 5435:5432, electric 3000:3000
- `frontend/vite.config.ts:8` — port 5173
- `frontend/.env.development:2` — `VITE_API_URL=http://localhost:4000` (points to hub, not self)

**enforcement** (`~/Desktop/sertantai-enforcement`):
- `config/dev.exs:44` — backend port 4002
- `docker-compose.dev.yml` — pg 5434:5432, electric 3001:3000, backend 4002:4002
- `frontend/vite.config.ts:8` — port 5173
- `frontend/.env` — `PUBLIC_API_URL=http://localhost:4002`, `PUBLIC_ELECTRIC_URL=http://localhost:3001`

**legal** (`~/Desktop/sertantai-legal`):
- `backend/config/dev.exs:29` — backend port 4003
- `docker-compose.dev.yml` — pg 5436:5432, electric 3002:3000
- `frontend/vite.config.ts:8` — port 5175
- `frontend/.env.development` — `VITE_API_URL=http://localhost:4003`

### Conflicts Found

**Backend ports** — no conflicts, all unique: auth=4000, controls=4001, enforcement=4002, legal=4003, hub=4006.

**PostgreSQL host ports** — conflicts:
- **5435**: auth (docker), hub, and controls all map to 5435
- auth dev.exs uses default 5432 (no Docker), so local dev doesn't conflict
- hub and controls both have `docker-compose` mapping 5435:5432 — can't run both Docker containers simultaneously
- Fix: controls → 5437 (as originally planned in hub README), auth docker → 5438

**Electric host ports** — conflicts:
- **3000**: hub and controls both map to 3000
- Fix: controls → 3003 (as originally planned in hub README)

**Frontend ports** — conflicts:
- **5173**: hub, controls, and enforcement all use 5173
- Fix: enforcement → 5174, controls → 5176 (as originally planned in hub README)

### Hub docker-compose internal issue

Backend env has `ELECTRIC_URL: http://electric:5133` but Electric container listens on port 3000 (`HTTP_PORT: 3000`). Port 5133 is wrong — likely a stale reference. Fix: change to `http://electric:3000`.

### Hub stale references after dev.exs→4006

Hub `dev.exs` already changed to 4006, but these still reference 4000:
- `docker-compose.dev.yml` — `PORT: 4000`, ports `4000:4000`
- `frontend/.env.development` — `VITE_API_URL=http://localhost:4000`
- `backend/.env.example` — `PORT=4000`

### Fixes Required

#### This repo (sertantai-legal) — documentation only
- [x] Update CLAUDE.md port table to match final allocations

#### sertantai-hub — code + docs
- [x] Update README.md port allocation table
- [x] Fix `docker-compose.dev.yml`: backend PORT→4006, ports→4006:4006
- [x] Fix `docker-compose.dev.yml`: ELECTRIC_URL→`http://electric:3000` (was 5133)
- [x] Fix `frontend/.env.development`: VITE_API_URL→`http://localhost:4006`
- [x] Fix `backend/.env.example`: PORT→4006

#### sertantai-controls — code
- [x] Fix `docker-compose.dev.yml`: pg port 5435→5437, electric port 3000→3003
- [x] Fix `backend/config/dev.exs`: pg fallback port 5435→5437
- [x] Fix `frontend/vite.config.ts`: port 5173→5176
- [x] Fix `frontend/.env.development`: VITE_API_URL port (currently points at hub:4000)

#### sertantai-enforcement — code
- [x] Fix `frontend/vite.config.ts`: port 5173→5174

#### sertantai-auth — code
- [x] Fix `docker-compose.dev.yml`: pg port 5435→5438

### Final Port Allocations (to be)

| Service | PostgreSQL | Electric | Backend | Frontend |
|---------|------------|----------|---------|----------|
| **auth** | 5438 | — | 4000 | — |
| **hub** | 5435 | 3000 | 4006 | 5173 |
| **enforcement** | 5434 | 3001 | 4002 | 5174 |
| **legal** | 5436 | 3002 | 4003 | 5175 |
| **controls** | 5437 | 3003 | 4004 | 5176 |

Note: hub backend moved from 4000→4006 because auth occupies 4000 in dev.
Note: controls backend stays at 4001 (reality), not 4004 (hub README aspiration). Minimal touch = doc matches reality.

**Wait** — controls backend is actually 4001 in code. The hub README had it at 4004. Minimal touch means we keep 4001 and update the docs. But auth docker-compose also uses 4001... Let me check: auth docker = 4001, controls dev.exs = 4001. That's a conflict if both run simultaneously. Need to decide:
- Option A: Move controls backend to 4004 (matches original hub README plan)
- Option B: Move auth docker to something else

Decision: **Option A** — controls→4004. Auth is the established service at 4001 (docker mode) and 4000 (dev mode). Controls is newer and was always planned for 4004. This is the one case where we change code to resolve a real conflict rather than just updating docs.

### Final Port Allocations (confirmed)

Daily dev ports (what you actually use with `mix phx.server` / `npm run dev`):

| Service | PostgreSQL | Electric | Backend | Frontend |
|---------|------------|----------|---------|----------|
| **auth** | 5432 (native) | — | 4000 | — |
| **hub** | 5435 | 3000 | 4006 | 5173 |
| **enforcement** | 5434 | 3001 | 4002 | 5174 |
| **legal** | 5436 | 3002 | 4003 | 5175 |
| **controls** | 5437 | 3003 | 4004 | 5176 |

Auth integration testing (pre-built image via `docker-compose.dev.yml`):
- PostgreSQL: 5438, Backend: 4001

All other services use their Docker postgres/Electric for daily dev.
Auth is the exception — pure backend, no Electric, uses native postgres.

---

## Phases 2-5 (unchanged)

### Phase 2: Frontend Auth Store + API Client
- [x] Create `stores/auth.ts` (login, register, logout, refresh, initialize)
- [x] Create `api/client.ts` (authenticated fetch wrapper)
- [x] Create `auth/jwt.ts` (JWT payload decoder)

### Phase 3: Login + Register Pages
- [x] Create `/login` page
- [x] Create `/register` page

### Phase 4: Auth Guard + Layout + NavBar
- [x] Update `+layout.svelte` with auth guard + initialize
- [x] Create `NavBar.svelte`
- [x] Update `+page.svelte` dashboard

### Phase 5: Token Refresh + Error Handling
- [x] Proactive refresh in auth store
- [x] 401 retry in API client

## Notes
- Hub uses `@sveltejs/adapter-static` (pure SPA) — no server-side route protection
- Auth API at sertantai-auth port 4000, hub proxies through backend
- Dev: token in localStorage + Svelte store; Prod: HttpOnly cookie (future)

**Ended**: 2026-02-19
