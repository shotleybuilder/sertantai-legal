# Issue #12: Add backend cancellation support for SSE parse streams

**Started**: 2026-01-29
**Ended**: 2026-01-29
**Issue**: https://github.com/shotleybuilder/sertantai-legal/issues/12

## Todo
- [x] Investigate Phoenix SSE disconnect detection patterns
- [x] Identify parse controller/endpoint handling SSE
- [x] Add disconnect detection between parse stages
- [x] Test cancellation behavior
- [x] Commit and push

## Implementation Summary

**Commit**: 4be414c

### Changes Made

**scrape_controller.ex** (lines 565-576):
- `send_progress` callback now checks `chunk()` return value
- Returns `:abort` when `{:error, :closed}` detected
- Final result not sent when parse was cancelled

**staged_parser.ex**:
- Callback signature updated: `(progress_event()) -> :ok | :abort`
- `notify_progress` return value checked after each stage notification
- Result includes `cancelled: true` flag when aborted
- Remaining stages marked with "Cancelled by client" error
- Telemetry includes `cancelled` metadata
- Console output shows "CANCELLED" status

### Tests Added
- `staged_parser_test.exs` - 6 new tests in "cancellation support" describe block
- Tests verify abort halts parsing, cancelled flag set, stages marked cancelled

## Investigation Findings

### SSE Endpoint Location
- `backend/lib/sertantai_legal_web/controllers/scrape_controller.ex`
- Function: `parse_stream/2`
- Route: `GET /api/sessions/:id/parse-stream?name=uksi/2025/568`

### Approach Used: Option A (Check chunk() return)
- Simplest approach, no architectural changes needed
- `Plug.Conn.chunk/2` returns `{:error, :closed}` when client disconnects
- Callback returns `:abort` to signal StagedParser to halt
