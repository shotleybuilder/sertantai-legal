# Issue #16: Consolidate Role article columns into JSONB field

**Started**: 2026-02-02 11:10 UTC
**Issue**: https://github.com/shotleybuilder/sertantai-legal/issues/16

## Todo

### Phase 1: Schema Migration ✅
- [x] Design JSONB structure for `role_details` and `role_gvt_details`
- [x] Backup DB
- [x] Create DB migration adding new JSONB columns
- [x] Create data migration script to transform text → JSONB
- [x] Test PostgreSQL JSONB queries
- [x] Commit: `6207610` feat(schema): Add role_details and role_gvt_details JSONB columns

### Phase 2: TaxaFormatter Layer ✅
- [x] Extend TaxaFormatter for Role JSONB conversion
- [x] Update TaxaParser to dual-write (text + JSONB)
- [x] Add JSONB fields to ParsedLaw struct
- [x] Commit: `6a961f9` feat(taxa): Add role_details JSONB generation in TaxaParser

### Phase 3: Frontend Update ✅
- [x] Add JSONB fields to TypeScript schema
- [x] Update ElectricSQL sync columns
- [x] Update field-config.ts
- [x] Update UI components
- [x] Commit: `e674025` feat(frontend): Add role_details JSONB support to frontend

### Phase 4: Cleanup ✅
- [x] Create migration to drop deprecated columns
- [x] Add GIN indexes on JSONB
- [x] Remove deprecated attributes from UkLrt resource
- [x] Remove deprecated fields from ParsedLaw
- [x] Commit: `5a70ca8` feat(cleanup): Drop deprecated role text columns, add GIN indexes (Issue #16 Phase 4)

### Phase 5: Manual Testing
- [x] Verify Role data displays correctly
- [x] Fix any bugs found

## Columns to Consolidate

| Column | Records | Storage |
|--------|---------|---------|
| `article_role` | 4986 | 2163 KB |
| `role_article` | 4986 | 807 KB |
| `role_gvt_article` | 4974 | 756 KB |
| `article_role_gvt` | 4974 | 1957 KB |
| **Total** | | **~5.7 MB** |

## Target JSONB Structure

```json
{
  "entries": [
    {"role": "Ind: Person", "article": "regulation/4"},
    {"role": "Org: Employer", "article": "section/2"}
  ],
  "roles": ["Ind: Person", "Org: Employer"],
  "articles": ["regulation/4", "section/2"]
}
```

## Phase 1 Results

**Migration completed**: 2026-02-02 11:35 UTC

- **Records migrated**: 5,866 (from 4 source columns)
- **role_details populated**: 4,986 records
- **role_gvt_details populated**: 4,974 records
- **Total entries**: 194,083 role/article pairs
- **Unique roles**: 23,256
- **Unique articles**: 89,937

**Files created**:
- `backend/priv/repo/migrations/20260202113111_add_role_details_jsonb.exs`
- `backend/scripts/data/migrate_role_columns_to_jsonb.exs`

**JSONB Query Tests**:
```sql
-- Find records with specific role
SELECT name FROM uk_lrt 
WHERE role_details->'roles' ? 'Ind: Employee';

-- Query entries by role and article type
SELECT name, entry->>'role', entry->>'article'
FROM uk_lrt, jsonb_array_elements(role_details->'entries') as entry
WHERE entry->>'role' = 'Org: Employer'
  AND entry->>'article' LIKE 'section/%';
```

## Phase 2 Results

**Completed**: 2026-02-02 12:05 UTC

**TaxaFormatter additions**:
- `roles_to_jsonb/2` - converts role list to JSONB with article context
- `merge_roles_jsonb/1` - merges multiple role JSONB results (for list merge)

**TaxaParser changes**:
- Chunked processing now extracts actors per-section (for article context in JSONB)
- Full-text actor extraction retained for `role`/`role_gvt` lists (comprehensive)
- Per-section actors used for `role_details`/`role_gvt_details` JSONB (article context)
- Added `merge_roles_jsonb/2` binary helper for reduce operation

**ParsedLaw additions**:
- `role_details: map() | nil` 
- `role_gvt_details: map() | nil`

**Test verification** (uksi/2025/581):
- role_details: 87 entries with article context
- role_gvt_details: 58 entries with article context
- All 697 tests pass

## Phase 3 Results

**Completed**: 2026-02-02 12:10 UTC

**TypeScript schema** (`uk-lrt-schema.ts`):
- Added `RoleEntry` interface: `{role: string, article: string | null}`
- Added `RoleJsonb` interface: `{entries, roles, articles}`
- Added `role_details` and `role_gvt_details` to `UkLrtRecord`
- Added `parseRoleJsonb()` function for data transformation

**ElectricSQL** (`sync-uk-lrt.ts`):
- Added `role_details` and `role_gvt_details` to UK_LRT_COLUMNS

**Field config** (`field-config.ts`):
- Added labels: `role_details: 'Role Details (JSONB)'`, `role_gvt_details: 'Role Gvt Details (JSONB)'`
- Added fields to Roles subsection in SECTION_CONFIG

**UI components**:
- Updated RecordDiff.svelte to include new fields in Taxa section

**Tests**:
- Updated uk-lrt-schema.test.ts with new fields
- All 95 frontend tests pass

## Phase 4 Results

**Completed**: 2026-02-02 13:20 UTC

**Migration** (`20260202131604_drop_role_text_columns_add_indexes.exs`):
- Dropped 4 deprecated columns: `article_role`, `role_article`, `article_role_gvt`, `role_gvt_article`
- Added GIN indexes:
  - `uk_lrt_role_details_gin_idx` on `role_details`
  - `uk_lrt_role_gvt_details_gin_idx` on `role_gvt_details`
- Storage savings: ~5.7 MB

**Backend cleanup**:
- Removed 4 deprecated attributes from `UkLrt` resource
- Removed `article_role` and `role_article` from `ParsedLaw` struct
- Updated `UkLrtController` to remove deprecated fields from accept list
- All 697 tests pass

**Frontend cleanup**:
- Removed deprecated columns from `UK_LRT_COLUMNS` in sync-uk-lrt.ts
- Removed deprecated fields from `UkLrtRecord` type in uk-lrt-schema.ts
- Removed deprecated labels and section config from field-config.ts
- All 95 tests pass

## Notes
- Pattern follows Issue #14 (holders) and Issue #15 (POPIMAR)
- Two target columns: `role_details` (non-gvt) and `role_gvt_details` (gvt roles)
- Expected ~80-90% storage reduction
- Source data format differs from holders: uses multi-line URL + roles, not `@` delimiters
- Design decision: `role` list uses full-text extraction (comprehensive), `role_details` uses per-section (article context)

---

**Ended**: 2026-02-02 13:25 UTC
