# Issue #4: Taxa

**Started**: 2025-12-26
**Issue**: https://github.com/shotleybuilder/sertantai-legal/issues/4

## Todo
- [x] Migrate data into dev db from .csv
- [x] Port the code from legl app
- [x] Testing - Added 99 tests covering:
  - DutyActor: 20 tests (actor extraction, blacklist filtering)
  - DutyType: 36 tests (duty type classification, role holders, sorting)
  - Popimar: 23 tests (POPIMAR category classification)
  - Integration: 20 tests (full pipeline processing)
- [x] Integrate Taxa processing into scraper/parser workflow
  - Created TaxaParser module (fetches law text, runs Taxa pipeline)
  - Added taxa as 5th stage in StagedParser
  - 17 additional tests for TaxaParser
- [x] Update scraper modal UI
  - Added duty_type, article/clause detail fields
  - Updated formatValue() for JSONB {items: [...]} format
  - Reorganized Roles (DRRP Model) section 

## Notes
- Source: `/home/jason/Desktop/legl/legl/lib/legl/countries/uk/legl_article/taxa`
- Data: `/home/jason/Documents/sertantai_data/UK-EXPORT.csv`

## Donor legl app

UK.lrt() -> Option: **LRT: UPDATE using an AT View** -> Option: **Taxa_from_leg_gov_uk**

## Taxa Schema
| Donor Field | DB Column | Friendly Name | In DB | Has Data | Notes | Parse Review Modal |
|-------------|-----------|---------------|-------|----------|-------|--------------------|
| actor | role | Role | âœ… varchar[] | 4,705 | | Yes - Roles (DRRP Model) |
| actor_gvt | role_gvt | Role Gvt | âœ… jsonb | 0 | | Yes - Roles (DRRP Model) |
| DUTY TYPE |
| duty_type | duty_type | Duty Type | âŒ ADD | - | | Yes - Roles (DRRP Model) |
| duty_type_article | duty_type_article | Duty Type Article | âœ… text | 0 | | Yes - Roles (DRRP Model) |
| article_duty_type | article_duty_type | Article Duty Type | âœ… text | 0 | | no |
| **DUTY HOLDER** |
| duty_holder | duty_holder | Duty Holder | âœ… jsonb | 0 | | Yes - Roles (DRRP Model)|
| duty_holder_article | duty_holder_article | Duty Holder Article | âœ… text | 0 | | no |
| duty_holder_article_clause | duty_holder_article_clause | Duty Holder Article Clause | âœ… text | 0 | | Yes - Roles (DRRP Model) |
| article_duty_holder | article_duty_holder | Article Duty Holder | âœ… text | 0 | | no |
| article_duty_holder_clause | article_duty_holder_clause | Article Duty Holder Clause | âœ… text | 0 | | no |
| **RIGHTS HOLDER** |
| rights_holder | rights_holder | Rights Holder | âœ… jsonb | 0 | | Yes - Roles (DRRP Model) |
| rights_holder_article | rights_holder_article | Rights Holder Article | âœ… text | 0 | | no |
| rights_holder_article_clause | rights_holder_article_clause | Rights Holder Article Clause | âœ… varchar | 0 | | Yes - Roles (DRRP Model) |
| article_rights_holder | article_rights_holder | Article Rights Holder | âœ… text | 0 | | no |
| article_rights_holder_clause | article_rights_holder_clause | Article Rights Holder Clause | âœ… varchar | 0 | | no |
| **RESPONSIBILITY HOLDER** |
| responsibility_holder | responsibility_holder | Responsibility Holder | âœ… jsonb | 0 | | Yes - Roles (DRRP Model) |
| responsibility_holder_article | responsibility_holder_article | Responsibility Holder Article | âœ… varchar | 0 | | no |
| responsibility_holder_article_clause | responsibility_holder_article_clause | Responsibility Holder Article Clause | âœ… varchar | 0 | | Yes - Roles (DRRP Model) |
| article_responsibility_holder | article_responsibility_holder | Article Responsibility Holder | âœ… varchar | 0 | | no |
| article_responsibility_holder_clause | article_responsibility_holder_clause | Article Responsibility Holder Clause | âœ… varchar | 0 | | no |
| **POWER HOLDER** |
| power_holder | power_holder | Power Holder | âœ… jsonb | 0 | | Yes - Roles (DRRP Model) |
| power_holder_article | power_holder_article | Power Holder Article | âœ… text | 0 | | no |
| power_holder_article_clause | power_holder_article_clause | Power Holder Article Clause | âœ… text | 0 | | Yes - Roles (DRRP Model) |
| article_power_holder | article_power_holder | Article Power Holder | âœ… text | 0 | | no |
| article_power_holder_clause | article_power_holder_clause | Article Power Holder Clause | âœ… text | 0 | | no |
| **POPIMAR** |
| popimar | popimar | Popimar | âœ… jsonb | 0 | | Yes - Roles (DRRP Model) |
| popimar_article | popimar_article | Popimar Article | âŒ ADD | - | | no |
| popimar_article_clause | popimar_article_clause | Popimar Article Clause | âœ… text | 0 | | Yes - Roles (DRRP Model) |
| article_popimar | article_popimar | Article Popimar | âŒ ADD | - | | no |
| article_popimar_clause | article_popimar_clause | Article Popimar Clause | âœ… text | 0 | | no |

## Migration Completed

`20251226122805_add_taxa_columns.exs` added:
- `duty_type` (text)
- `duty_type_article` (text)
- `article_duty_type` (text)
- `popimar_article` (text)
- `article_popimar` (text)

No renames needed - `role` and `role_gvt` already exist in DB.

## Data Import Results

Script: `scripts/data/update_uk_lrt_taxa.exs`
Run: `cd backend && mix run ../scripts/data/update_uk_lrt_taxa.exs`

| Column | Records |
|--------|---------|
| duty_type | 7,775 |
| role | 4,986 |
| role_gvt | 4,974 |
| popimar | 4,707 |
| responsibility_holder | 2,513 |
| duty_holder | 2,450 |
| power_holder | 2,121 |
| rights_holder | 1,812 |

### actor

/home/jason/Desktop/legl/legl/lib/legl/countries/uk/legl_article/taxa/duty_actor/actor_definitions.ex

### duty_type

[Duty, Right, Responsibility, Power]

### duty_holder_article

Example:
```
[Ind: Person]
https://legislation.gov.uk/ukpga/1920/Geo5/10-11/65/section/1

[Org: Employer]
https://legislation.gov.uk/ukpga/1920/Geo5/10-11/65/section/1
```

### duty_holder_article_clause
Example:
```
[Ind: Person]
https://legislation.gov.uk/ukpga/1920/Geo5/10-11/65/section/1
DUTY
ğŸ‘¤Ind: Person
ğŸ“Œ person being the employer of a [F10 person under the age of sixteen years] fails to keep such a register so required to be kept by him as aforesaid, or refuses or neglects when required to produce it for inspection by an officer of a local authority under the said Act, he shall be liable
DUTY
ğŸ‘¤Ind: Person
ğŸ“Œ person being the employer of a [F10 person under the age of sixteen years] fails to keep such a register so required to be kept by him as aforesaid, or refuses or neglects when required to produce it for inspection by an officer of a local authority under the said Act, he shall
DUTY
ğŸ‘¤Ind: Person
ğŸ“Œany person being the employer of a [F10 person under the age of sixteen years] fails to keep such a register so required to be kept by him as aforesaid, or refuses or neglects when required to produce it for inspection by an officer of a local authority under the said Act, he shall

[Org: Employer]
https://legislation.gov.uk/ukpga/1920/Geo5/10-11/65/section/1
DUTY
ğŸ‘¤Org: Employer
ğŸ“Œ employer of a [F10 person under the age of sixteen years] fails to keep such a register so required to be kept by him as aforesaid, or refuses or neglects when required to produce it for inspection by an officer of a local authority under the said Act, he shall be liable
DUTY
ğŸ‘¤Org: Employer
ğŸ“Œ employer of a [F10 person under the age of sixteen years] fails to keep such a register so required to be kept by him as aforesaid, or refuses or neglects when required to produce it for inspection by an officer of a local authority under the said Act, he shall
DUTY
ğŸ‘¤Org: Employer
ğŸ“Œthe employer of a [F10 person under the age of sixteen years] fails to keep such a register so required to be kept by him as aforesaid, or refuses or neglects when required to produce it for inspection by an officer of a local authority under the said Act, he shall
```
## Taxa Source Code Summary

  Location: /home/jason/Desktop/legl/legl/lib/legl/countries/uk/legl_article/taxa/

  Size: ~2,495 lines across 13 modules

  ### Directory Structure

  taxa/
  â”œâ”€â”€ lat_taxa.ex              # Orchestration (LAT workflow)
  â”œâ”€â”€ lrt_taxa.ex              # LRT workflow
  â”œâ”€â”€ options.ex               # Configuration
  â”‚
  â”œâ”€â”€ duty_actor/              # Role identification
  â”‚   â”œâ”€â”€ duty_actor.ex        # Main processing
  â”‚   â”œâ”€â”€ actor_lib.ex         # Utilities
  â”‚   â””â”€â”€ actor_definitions.ex # 100+ regex patterns (372 lines)
  â”‚
  â”œâ”€â”€ taxa_duty_type/          # Duty classification
  â”‚   â”œâ”€â”€ duty_type.ex         # Main processing (371 lines)
  â”‚   â”œâ”€â”€ duty_type_lib.ex     # Utilities (219 lines)
  â”‚   â”œâ”€â”€ duty_type_defn.ex    # Pattern definitions
  â”‚   â”œâ”€â”€ duty_type_defn_governed.ex
  â”‚   â””â”€â”€ duty_type_defn_government.ex
  â”‚
  â””â”€â”€ taxa_popimar/            # POPIMAR taxonomy
      â”œâ”€â”€ popimar.ex           # Main processing (352 lines)
      â””â”€â”€ popimar_lib.ex       # Regex patterns
    
  ### Processing Pipeline
  
    Text â†’ DutyActor â†’ DutyType â†’ POPIMAR â†’ Aggregates
             â†“            â†“          â†“
        Duty Actor    Dutyholder   Policy
        Duty Actor Gvt Rights_Holder Organisation
                      Responsibility_Holder Risk Control
                      Power_Holder  Notification
                      Duty Type     etc.
  
  ### Key Components

  | Module           | Purpose                                                          |
  |------------------|------------------------------------------------------------------|
  | ActorDefinitions | 100+ regex patterns for actors (Governed + Government)           |
  | DutyType         | Classifies into 20 duty types (Duty, Right, Power, etc.)         |
  | Popimar          | 16 POPIMAR categories (Policy, Organisation, Risk Control, etc.) |

  ### Porting Considerations

  1. Replace Airtable â†’ Ash database queries
  2. Regex patterns â†’ Can be ported directly
  3. Options system â†’ Simplify with Elixir config
  4. Hierarchical aggregation â†’ May not be needed (already at law level)

  The core value is in the regex pattern libraries - these are the classification rules built up over time.

## Ported Modules

### ActorDefinitions âœ…
`lib/sertantai_legal/legal/taxa/actor_definitions.ex`

- 129 regex patterns (45 government + 84 governed)
- Categories: Crown, Authorities, Agencies, Ministers, Devolved Admins, Business, Person, Specialist, Supply Chain, Maritime, Environmental

### ActorLib âœ…
`lib/sertantai_legal/legal/taxa/actor_lib.ex`

- `workflow/2` - Extract actors from text
- `process/3` - Run regex patterns against text
- `custom_actor_library/2` - Build subset libraries
- `dutyholders_regex/1` - Create OR group patterns

### DutyActor âœ…
`lib/sertantai_legal/legal/taxa/duty_actor.ex`

- `get_actors_in_text/1` - Extract both governed + government actors
- `get_governed_actors/1` - Extract non-government actors (role)
- `get_government_actors/1` - Extract government actors (role_gvt)
- `process_record/1` - Process single law record
- `process_records/1` - Batch process law records

### DutyType âœ… (5 modules)

**DutyTypeDefn** - `lib/sertantai_legal/legal/taxa/duty_type_defn.ex`
- Generic duty type patterns (enaction, interpretation, scope, etc.)
- 13 pattern categories

**DutyTypeDefnGoverned** - `lib/sertantai_legal/legal/taxa/duty_type_defn_governed.ex`
- Patterns for duties/rights on non-government entities
- `duty/1`, `right/1` pattern generators

**DutyTypeDefnGovernment** - `lib/sertantai_legal/legal/taxa/duty_type_defn_government.ex`
- Patterns for responsibilities/powers on government
- `responsibility/1`, `power_conferred/1` pattern generators

**DutyTypeLib** - `lib/sertantai_legal/legal/taxa/duty_type_lib.ex`
- `find_role_holders/4` - Find duty/rights/resp/power holders
- `duty_types_generic/1` - Extract generic duty types
- `process/2`, `blacklist/1`, `build_lib/2`

**DutyType** - `lib/sertantai_legal/legal/taxa/duty_type.ex`
- `get_duty_types/1` - Get duty types from text
- `process_record/1` - Full classification with role holders
- `duty_type_sorter/1` - Sort by priority

### POPIMAR âœ… (2 modules)

**PopimarLib** - `lib/sertantai_legal/legal/taxa/popimar_lib.ex`
- 16 POPIMAR category pattern functions
- `regex/1` - Build compiled regex from patterns

**Popimar** - `lib/sertantai_legal/legal/taxa/popimar.ex`
- `get_popimar/1` - Get POPIMAR categories from text
- `get_popimar/2` - With duty type consideration
- `process_record/1` - Process law record
- `popimar_sorter/1` - Sort by priority

## Session Updates

### 2025-12-26 (continued)
- Integrated Taxa as 5th stage in StagedParser
- Created TaxaParser module (fetches law text from legislation.gov.uk, runs classification pipeline)
- 17 additional tests for TaxaParser (116 total tests)
- Fixed Dialyzer warnings
- Pushed commit 69b3f69
- Updated ParseReviewModal.svelte with Taxa fields display
- Pushed commit 07b3b8c

**Issue #4 Complete** - All todos done
