# Issue #11: Implement Extensible Telemetry and Performance Metrics System

**Started**: 2026-01-28
**Issue**: https://github.com/shotleybuilder/sertantai-legal/issues/11

## Todo
- [x] Create file-based metrics store (JSON)
- [x] Attach telemetry handler at app startup
- [x] Add IEx helpers for comparing runs
- [x] Add summary output (P50/P95/P99)
- [x] Create tests (26 tests passing)
- [x] Commit and push (bcc4df4)

## Notes
- JSON files for persistence across restarts
- Current telemetry event: `[:taxa, :classify, :complete]`
- See `backend/lib/sertantai_legal_web/telemetry.ex` for existing setup

## Storage Structure Options

### Option A: Append-only Log File (NDJSON)
Single file with one JSON object per line (Newline Delimited JSON).

```
priv/metrics/taxa_metrics.ndjson
```

Each line:
```json
{"timestamp":"2026-01-28T18:30:00Z","law_id":"uuid","duration_us":1234,...}
```

**Pros**: Simple, standard format (used by Elasticsearch, BigQuery, logging systems), easy to append, streamable, `tail -f` friendly, tools like `jq` work line-by-line
**Cons**: File grows indefinitely, need rotation strategy for long-term

### Option B: Daily Log Files (NDJSON)
One file per day, NDJSON format.

```
priv/metrics/
├── taxa_2026-01-28.ndjson
├── taxa_2026-01-29.ndjson
└── ...
```

**Pros**: Natural rotation, easy to compare days, can delete old files, still streamable
**Cons**: Comparing across days requires loading multiple files

### Option C: Tagged Run Files
Explicit "runs" with user-defined tags for before/after comparison.

```
priv/metrics/
├── baseline_2026-01-28.ndjson
├── after-regex-precompile_2026-01-28.ndjson
└── ...
```

**Pros**: Clear before/after semantics, intentional comparisons
**Cons**: Requires manual tagging, more user friction

### Option D: Git-style Objects
Content-addressed storage with run manifests.

```
priv/metrics/
├── runs/
│   ├── abc123.json  # run manifest with metadata
│   └── def456.json
└── events/
    ├── <hash>.json  # individual events
    └── ...
```

**Pros**: Deduplication, immutable history
**Cons**: Over-engineered for dev metrics

---

## Recommendation: Option B (Daily NDJSON)

**Why**: Industry standard for observability (Prometheus, Loki, ELK stack all use time-based partitioning). NDJSON is the de facto format for structured logs. Daily rotation provides natural boundaries without manual intervention.

**Comparison workflow**:
```elixir
# Compare today's P95 vs yesterday
Metrics.compare("taxa_2026-01-28", "taxa_2026-01-27")

# Or filter by time range within a day
Metrics.summary("taxa_2026-01-28", after: ~T[14:00:00])
```

**Rotation**: Keep last 7-30 days, configurable. Old files auto-deleted or archived.

---

## Scope: Dev/Test Only

**This implementation is for development and testing only.**

- File-based NDJSON in `priv/metrics/` (gitignored)
- No production scaling, querying, or alerting capabilities
- Designed for local before/after performance comparisons

**Production requirements** (future issue):
- OpenTelemetry export to observability stack (Prometheus/Grafana, Datadog, Honeycomb, etc.)
- Proper querying, dashboards, alerting
- Scalable storage backend

**Foundation for production**: The `:telemetry` events and handler architecture built here are production-ready. Only the file-based storage backend is dev-only. Production implementation would swap `FileStore` for `OtelExporter` without changing parsing code.

---

## Implementation

**Commit**: bcc4df4

**Files created**:
- `lib/sertantai_legal/metrics.ex` - Convenience module for IEx
- `lib/sertantai_legal/metrics/file_store.ex` - NDJSON file storage
- `lib/sertantai_legal/metrics/reporter.ex` - Summary/comparison reporting
- `lib/sertantai_legal/metrics/telemetry_handler.ex` - Telemetry event handler

**Usage**:
```elixir
Metrics.summary()                              # Today's P50/P95/P99
Metrics.compare("2026-01-28", "2026-01-27")    # Before/after
Metrics.list()                                 # Available files
Metrics.export("2026-01-28", format: :csv)     # Export
```

---

**Ended**: 2026-01-28
