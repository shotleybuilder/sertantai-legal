# Consolidate POPIMAR article columns into JSONB field

**Started**: 2026-02-02 08:45 UTC
**Issue**: https://github.com/shotleybuilder/sertantai-legal/issues/15

## Todo

### Phase 1: Schema Migration ✅ COMPLETE
- [x] Analyze current POPIMAR column data (popimar_article, popimar_article_clause, article_popimar, article_popimar_clause)
- [x] Design JSONB structure for `popimar_details`
- [x] Create DB migration adding new JSONB column
- [x] Create data migration script to transform existing text → JSONB
- [x] Test PostgreSQL JSONB queries against migrated data
- [x] Backup DB

#### Phase 1 Results
| Metric | Value |
|--------|-------|
| Records migrated | 4,707 |
| Old columns storage | 2.8 MB |
| New column storage | 1.7 MB |
| **Storage reduction** | **~39%** |

#### JSONB Structure

{
  "entries": [{"category": "Records", "article": "regulation/4"}],
  "categories": ["Records", ...],
  "articles": ["regulation/4", ...]
}

Backup: `~/Documents/sertantai-data/sertantai_legal_dev_20260202_094039.sql`

Commits:
- `903417d` - feat(phase1-issue15): Add popimar_details JSONB column and data migration

### Phase 2: TaxaFormatter Layer ✅ COMPLETE
- [x] Extend TaxaFormatter for POPIMAR JSONB conversion
- [x] Update TaxaParser to dual-write (text + JSONB)
- [x] Add JSONB field to ParsedLaw struct

#### Phase 2 Files Changed
| File | Changes |
|------|---------|
| `taxa_formatter.ex` | +popimar_to_jsonb/2, +merge_popimar_jsonb/1 |
| `parsed_law.ex` | +popimar_details field |
| `taxa_parser.ex` | Produces both popimar (list) and popimar_details (JSONB) |

Commits:
- `b3551d4` - feat(phase2-issue15): Add POPIMAR JSONB dual-write in TaxaParser

### Phase 3: Frontend Update ✅ COMPLETE
- [x] Add JSONB field to TypeScript schema
- [x] Update ElectricSQL sync columns
- [x] Update field-config.ts
- [x] Update UI components

#### Phase 3 Files Changed
| File | Changes |
|------|---------|
| `uk-lrt-schema.ts` | +PopimarEntry, +PopimarJsonb interfaces, +popimar_details field, +parsePopimarJsonb |
| `uk-lrt-schema.test.ts` | +popimar_details to test record |
| `sync-uk-lrt.ts` | +popimar_details to UK_LRT_COLUMNS |
| `field-config.ts` | +popimar_details label and SECTION_CONFIG entry |
| `RecordDiff.svelte` | +popimar_details to Roles field group |
| `admin/lrt/+page.svelte` | +popimar_details type, column def, and column group |

Commits:
- `f0ca0cb` - feat(frontend): Add popimar_details JSONB field to frontend (Phase 3 Issue #15)

### Bug Fix: POPIMAR article null values ✅ FIXED
- [x] Identified issue: POPIMAR ran on merged text, losing per-section article context
- [x] Moved POPIMAR processing to per-section loop (alongside DutyType)
- [x] Added `:article` option to `Popimar.process_record/2`
- [x] Added `popimar_details` generation in Popimar module
- [x] Added `merge_popimar_jsonb/2` helper in TaxaParser
- [x] Verified: `uksi/2025/581` now produces 122 entries with correct article refs

#### Bug Fix Files Changed
| File | Changes |
|------|---------|
| `popimar.ex` | +process_record/2 with :article option, generates popimar_details with article context |
| `taxa_parser.ex` | POPIMAR now runs per-section in chunked mode, +merge_popimar_jsonb/2, +run_purpose_classification/1 |

Commits:
- `32c5c49` - fix(taxa): Add article context to POPIMAR JSONB in chunked processing

### Phase 4: Cleanup ✅ COMPLETE
- [x] Create migration to drop deprecated columns
- [x] Add GIN indexes on JSONB
- [x] Remove deprecated attributes from UkLrt resource
- [x] Remove deprecated fields from ParsedLaw
- [x] Update controller to use popimar_details

#### Phase 4 Migration
```sql
-- Dropped columns:
--   popimar_article, popimar_article_clause, article_popimar, article_popimar_clause

-- Added GIN indexes:
CREATE INDEX idx_uk_lrt_popimar_categories ON uk_lrt 
  USING GIN ((popimar_details->'categories')) 
  WHERE popimar_details IS NOT NULL;

CREATE INDEX idx_uk_lrt_popimar_entries ON uk_lrt 
  USING GIN ((popimar_details->'entries') jsonb_path_ops) 
  WHERE popimar_details IS NOT NULL;
```

#### Phase 4 Files Changed
| File | Changes |
|------|---------|
| `uk_lrt.ex` | Removed 4 deprecated attributes and from accept lists |
| `parsed_law.ex` | Removed from type, defstruct, and from_map |
| `uk_lrt_controller.ex` | Updated to use popimar_details instead of text columns |
| `20260202104708_drop_popimar_text_columns_phase4.exs` | Migration to drop columns and add indexes |

Commits:
- `5c4e8e3` - feat(phase4-issue15): Drop deprecated POPIMAR text columns, add GIN indexes

### Phase 5: Manual Testing
- [ ] Verify POPIMAR data displays correctly
- [ ] Fix any bugs found

## Notes
- Pattern follows Issue #14 (holder consolidation)
- 4 text columns → 1 JSONB column

---

## Schema Design Analysis: Normalized vs Category-Keyed

### Current Structure (Normalized/Entries Array)

```json
{
  "entries": [
    {"category": "Records", "article": "regulation/4"},
    {"category": "Risk Control", "article": "regulation/2"},
    {"category": "Risk Control", "article": "regulation/4"}
  ],
  "categories": ["Records", "Risk Control"],
  "articles": ["regulation/2", "regulation/4"]
}
```

### Alternative Structure (Category as Keys)

```json
{
  "Records": ["regulation/4"],
  "Risk Control": ["regulation/2", "regulation/4"]
}
```

### Comparison

| Criteria | Normalized (Current) | Category-Keyed |
|----------|---------------------|----------------|
| **Storage** | Larger (repeats category names) | Smaller |
| **Query: "Has category X?"** | `categories ? 'Risk Control'` ✅ Fast with GIN | `? 'Risk Control'` ✅ Fast with GIN |
| **Query: "Category X at article Y?"** | `entries @> '[{"category":"X","article":"Y"}]'` ✅ Single operator | `'Risk Control' ? 'regulation/4'` requires knowing key |
| **Query: "All categories for law"** | `categories` array ready ✅ | `jsonb_object_keys()` needed |
| **Query: "All articles for law"** | `articles` array ready ✅ | Must aggregate across all keys |
| **Query: "Articles for category X"** | Filter entries array | Direct key access `->>'Risk Control'` ✅ |
| **GIN Index efficiency** | `jsonb_path_ops` on entries supports containment | Works for key existence only |
| **Schema evolution** | Add fields to entries easily | Would need nested objects |
| **Aggregation (category counts)** | `jsonb_array_elements_text(categories)` ✅ | `jsonb_object_keys()` ✅ |
| **Frontend iteration** | `entries.map()` natural | `Object.entries()` then flatten |

### Query Performance Tests (on 4,707 records)

**1. Find laws with "Risk Control" category:**
- Current: `popimar_details->'categories' ? 'Risk Control'` — 0.7ms
- Alternative: `popimar_details ? 'Risk Control'` — similar with GIN

**2. Category distribution (aggregation):**
```sql
-- Current structure: Simple
SELECT category, count(*) 
FROM uk_lrt, jsonb_array_elements_text(popimar_details->'categories') category
GROUP BY category;

-- Results: Risk Control (3,723), Records (2,396), Maintenance (1,866)...
```

**3. Find specific category+article combination:**
```sql
-- Current: Uses containment operator (GIN-indexable)
SELECT name FROM uk_lrt 
WHERE popimar_details->'entries' @> '[{"category":"Risk Control","article":"regulation/4"}]';

-- Alternative: Requires two-step or nested query
SELECT name FROM uk_lrt 
WHERE popimar_details->'Risk Control' ? 'regulation/4';
```

### Recommendation: Keep Current Normalized Structure ✅

**Reasons:**

1. **Pre-computed convenience arrays** — `categories` and `articles` arrays provide O(1) access for common queries without needing to scan/aggregate entries

2. **GIN index efficiency** — The `@>` containment operator on `entries` array is highly optimized with `jsonb_path_ops` GIN index for multi-field searches

3. **Schema extensibility** — If we later need to add metadata per entry (e.g., `confidence_score`, `source`, `clause_text`), the entries structure accommodates this naturally:
   ```json
   {"category": "Risk Control", "article": "regulation/4", "confidence": 0.95}
   ```

4. **Consistent with holder fields** — The `duties`, `rights`, `responsibilities`, `powers` JSONB fields from Issue #14 use the same normalized entries pattern, maintaining codebase consistency

5. **Frontend simplicity** — Iterating `entries.map(e => ...)` is more natural than `Object.entries(obj).flatMap(([cat, articles]) => articles.map(...))`

6. **ElectricSQL sync** — Normalized structure serializes predictably; dynamic keys could cause issues with schema inference

**Trade-off accepted:** ~20% more storage due to repeated category names in entries. This is acceptable given:
- Total POPIMAR data is only 1.7 MB
- Query flexibility and indexing benefits outweigh storage cost
- Pre-computed arrays eliminate runtime aggregation

### Index Recommendation for Phase 4

```sql
-- For category lookups
CREATE INDEX idx_uk_lrt_popimar_categories ON uk_lrt USING GIN ((popimar_details->'categories'));

-- For category+article combination searches
CREATE INDEX idx_uk_lrt_popimar_entries ON uk_lrt USING GIN ((popimar_details->'entries') jsonb_path_ops);
```

**Ended**: 2026-02-02 10:55 UTC
