# Issue #5: Admin Data View & Edit

**Started**: 2025-12-29
**Issue**: https://github.com/shotleybuilder/sertantai-legal/issues/5

## Todo
- [x] Review sertantai-enforcement data view patterns
- [x] Install required NPM packages (svelte-table-kit, svelte-table-views-tanstack)
- [x] Create /admin/lrt route with TableKit
- [x] Configure column views to minimize horizontal scroll
- [x] Implement inline editing for: family, family_ii, function
- [x] Add per-row rescrape button to re-run scraper
- [x] Create backend endpoint for single-record rescrape
- [x] Update ports to avoid conflicts with other sertantai services
- [x] Commit changes
- [x] Implement Saved Views feature (like sertantai-enforcement/data)

## Notes
- Reference: sertantai-enforcement/data view patterns
- Key libs: @shotleybuilder/svelte-table-kit, @tanstack/svelte-table, svelte-table-views-tanstack
- Route: /admin/lrt (not /admin/data)
- Inline editable fields: family, family_ii, function (dropdown selects)
- Per-row rescrape button: triggers StagedParser.parse() to refresh data from legislation.gov.uk
- Use case: fixing scraper bugs then bulk re-scraping affected records
- Minimize horizontal scroll via column views (not eliminate)

## Implementation Summary

### Files Created/Modified:
- `frontend/src/app.css` - Added @source directives for table-kit packages
- `frontend/src/routes/admin/+layout.svelte` - Added "LRT Data" nav link
- `frontend/src/routes/admin/lrt/+page.svelte` - New admin data view page
- `backend/lib/sertantai_legal_web/router.ex` - Added rescrape endpoint route
- `backend/lib/sertantai_legal_web/controllers/uk_lrt_controller.ex` - Added rescrape/2 action
- `frontend/vite.config.ts` - Updated port 5173 → 5175
- `backend/config/dev.exs` - Updated port 4000 → 4003
- `docker-compose.dev.yml` - Updated all service ports
- `CLAUDE.md` - Updated port references
- `sertantai-hub/README.md` - Added port allocation table

### Features:
- TableKit table with column visibility, resizing, reordering, filtering, sorting, pagination
- Double-click inline editing for family, family_ii (dropdown selects), function (multi-select toggles)
- Per-row rescrape button that calls StagedParser.parse() and updates the record
- State persistence to localStorage

### Port Allocation:
| Service | PostgreSQL | Electric | Backend | Frontend |
|---------|------------|----------|---------|----------|
| hub | 5435 | 3000 | 4000 | 5173 |
| enforcement | 5434 | 3001 | 4002 | 5174 |
| **legal** | **5436** | **3002** | **4003** | **5175** |

### Saved Views Feature:
- Uses `svelte-table-views-tanstack` library v0.1.7 (preload() for reliable TanStack DB init)
- Components: `ViewSelector` dropdown, `SaveViewModal` dialog
- Stores: `activeViewId`, `activeViewModified`, `viewActions`
- Split button UI: "Update View" / "Save New" when view is modified
- Default views seeded on first load: Credentials, Description, Status & Dates, Geo. Extent, Metadata
- Clicking a view applies column visibility config via TableKit `config` prop

### Commits:
- `7a26a94` feat: Add admin LRT data view with inline editing and rescrape
- `619aaad` fix: Use viewActions.save() API for seeding default saved views
- `1a043be` fix: Update start/stop scripts to use correct ports (4003/5175)
- `be41254` feat: Implement saved views with column config application
- `a673c18` fix: Update svelte-table-views-tanstack to 0.1.7

### Library Fixes (svelte-table-views-tanstack):
- v0.1.5: Wait for TanStack DB collection readiness before reading
- v0.1.6: Use onFirstReady() instead of onReady()
- v0.1.7: Use preload() for reliable localStorage sync (final fix)

**Ended**: 2025-12-29
