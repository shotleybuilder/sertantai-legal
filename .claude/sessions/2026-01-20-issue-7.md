# Issue #7: Filter self-references from amendment relationship fields

**Started**: 2026-01-20 16:20 UTC
**Completed**: 2026-01-20
**Issue**: https://github.com/shotleybuilder/sertantai-legal/issues/7

## Todo

### Schema Extension (preserve self-reference data)
- [x] Add `stats_self_affects_count_per_law_detailed` field to `uk_lrt.ex` (string, like other _detailed fields)
- [x] Add field to `ParsedLaw` struct
- [x] Generate migration for new column
- **Commit**: `9ab1074`

### Filter & Capture Self-References
- [x] Modify `Amending.get_laws_amended_by_this_law/1` - separate self from others
- [x] Modify `Amending.get_laws_amending_this_law/1` - separate self from others
- [x] Return self-amendments in separate key (`self_amendments: [...]`, `self_revocations: [...]`)
- [x] Update `build_stats_with_self/4` to compute accurate `self_amendments_count`

### Stats Builders in staged_parser.ex
- [x] Build `stats_self_affects_count_per_law_detailed` from self-amendments
- [x] Exclude self from regular `_per_law` and `_per_law_detailed` fields
- [x] Combine self-amendments from both affecting and affected directions

### Testing
- [x] Add tests for self-reference filtering in `amending_test.exs` (5 new tests)
- [x] Created test fixture `amendments_with_self_refs.html`
- [x] Verify cascade update no longer includes self
- **Commit**: `4ee4988`

### UI & Documentation Updates
- [x] **ParseReviewModal.svelte** - Add display block for `stats_self_affects_count_per_law_detailed` in SECTION 6 (Function)
- [x] **RecordDiff.svelte** - Add `stats_self_affects_count_per_law_detailed` to `fieldGroups.Function` array
- [x] **LRT-SCHEMA.md** - Add row to Self-Affects section documenting the new field
- **Commit**: `21f2d82`

## Summary

Self-referencing amendments (e.g., "coming into force" provisions) are now:
1. **Filtered out** of `amending`/`amended_by` arrays to prevent cascade circularity
2. **Preserved** in `stats_self_affects_count` (integer) and `stats_self_affects_count_per_law_detailed` (string)
3. **Accurately counted** - field was previously always 0
4. **Visible in UI** - ParseReviewModal displays detail, RecordDiff includes in diffs

### Key Changes
- `Amending` module: New `fetch_and_parse_amendments_with_self_filter/2` separates self from others
- `staged_parser.ex`: Combines self-amendments from both directions, builds detailed string
- Fixed dialyzer pattern match coverage issue with explicit patterns
- Added dialyzer ignore for false positive unused function warnings
- UI components updated to display and diff the new field

### Files Modified
- `backend/lib/sertantai_legal/scraper/amending.ex`
- `backend/lib/sertantai_legal/scraper/staged_parser.ex`
- `backend/.dialyzer_ignore.exs`
- `backend/test/sertantai_legal/scraper/amending_test.exs`
- `backend/test/fixtures/legislation_gov_uk/amendments_with_self_refs.html` (new)
- `frontend/src/lib/components/ParseReviewModal.svelte`
- `frontend/src/lib/components/RecordDiff.svelte`
- `docs/LRT-SCHEMA.md`

## Notes
- Test law: UK_uksi_2025_585 (East Yorkshire Solar Farm Order) has 235+ self-amendments
- All 522 tests pass
- Closes #7

**Ended**: 2026-01-21 14:30 UTC
