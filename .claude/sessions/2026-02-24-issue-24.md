# Issue #24: Reconcile three conflicting vocabularies in UK LRT holder and function fields

**Started**: 2026-02-24 11:46
**Issue**: https://github.com/shotleybuilder/sertantai-legal/issues/24
**Prior research**: `.claude/sessions/2026-02-24-duty-detection-research.md`

## Todo
- [x] Item 1: `function`, `is_making`, `is_commencing` â€” schema, bug fix, data repair
- [x] Item 2: `purpose` and `duty_type` â€” schema documented, taxa parser verified
- [x] Item 3: Holder fields â€” ONE vocabulary (Airtable prefixed = taxa parser), no conflict
- [x] Deprecate import_uk_lrt.sql as primary import path
- [x] Decide vocabulary strategy â€” N/A, already unified (one vocabulary, not three)
- [x] Create `docs/HOLDER_VALUES.md` documenting canonical holder taxonomy
- [x] Dev DB dump created: `~/Documents/sertantai-data/sertantai_legal_dev_20260224_175747.sql`
- [x] Issue #26: holder data quality fixes (13 records)
- [x] Issue #27: sync production DB with dev data fixes

## Notes
- ~~Three vocabularies~~ Actually ONE vocabulary â€” Airtable prefixed and taxa parser are identical
- SQL dump has NULL holders -- DB holders came from CSV import + taxa parser post-import
- CSV updater writes function/is_making; taxa updater writes holders, duty_type, purpose, role, POPIMAR

---

## Item 1: `function`, `is_making`, `is_commencing`

### Desired Schema (from `docs/LRT-SCHEMA.md`)

| Column | Type | Has Data | Example | Stage |
|--------|------|:--------:|---------|-------|
| `function` | `map` (JSONB) | Yes (12858) | `{"Making": true, "Amending Maker": true}` | ðŸ§®_derived |
| `is_making` | `boolean` | Yes (19089) | `true` | ðŸ§®_derived |
| `is_commencing` | `boolean` | Yes (19089) | `false` | ðŸ§®_derived |

### Canonical Members (Airtable Function multi-select â€” 8 tags)

| Tag | Meaning | CSV Count |
|-----|---------|-----------|
| **Making** | Creates new substantive duties/obligations | 3,186 (16.3%) |
| **Amending** | Modifies existing legislation (targets are non-makers) | 7,420 (37.9%) |
| **Amending Maker** | Modifies existing legislation that IS a maker | 6,213 (31.7%) |
| **Revoking** | Repeals/revokes other laws (targets are non-makers) | 2,329 (11.9%) |
| **Revoking Maker** | Repeals/revokes other laws that ARE makers | 697 (3.6%) |
| **Commencing** | Brings other laws into force | 1,505 (7.7%) |
| **Enacting** | Primary legislation enabling SIs (targets are non-makers) | 622 (3.2%) |
| **Enacting Maker** | Primary legislation enabling SIs that ARE makers | 234 (1.2%) |

- 12,860 CSV records have Function data; 6,713 are empty
- 107 unique tag combinations
- "Maker" suffix = the TARGET law has `Making` in its own Function (graph/network relationship)

### Current State of Data in DB (verified 2026-02-24)

**CORRECTION**: The research session doc incorrectly claimed the DB had old TEXT format values. Actual DB query shows the function field is already proper JSONB. The research session likely examined the SQL dump *file* and assumed that's what the DB contained.

**Actual DB state** (19,318 records total):

| Category | Count | `function` | `is_making` |
|----------|-------|-----------|-------------|
| Proper JSONB from CSV/Calculator | 12,858 | `{"Making": true, ...}` | `true`/`false` |
| No CSV Function data | 6,231 | `NULL` | `false` |
| Fully NULL | 229 | `NULL` | `NULL` |

**Update timeline** (from `updated_at`):
- Jan 17: 7,457 records (initial batch)
- Jan 20: 10,988 records (second batch)
- Jan 27-29: 10 records
- Feb 4-5: 863 records (likely FunctionCalculator on previously-empty records)

**Three writers exist** but DB was never in old TEXT state:

| Writer | `function` format | `is_making` format |
|--------|-------------------|-------------------|
| SQL dump (`import_uk_lrt.sql`) | TEXT: `'Amendment'`, etc. | TEXT: `'Act'`/`'SI'` |
| CSV updater (`update_uk_lrt_function.exs`) | JSONB: `{"Making": true, ...}` | boolean |
| FunctionCalculator (`function_calculator.ex`) | JSONB: `{"Making": true, ...}` | boolean |

### Problems

1. ~~**`docs/FUNCTION_VALUES.md` is outdated**~~ â€” FIXED
2. **6,460 records have NULL function** â€” 6,231 with `is_making=false`, 229 fully NULL
3. **2 CSV records not in DB** (`UK_eudr_2013_0051`, `UK_uksi_1985_612`)
4. **No validation** prevents TEXT being stored in the JSONB column if SQL dump is re-run
5. **Research session doc contains incorrect claims** about DB state â€” should be corrected or flagged

### BUG: Parsing pipeline does NOT derive `is_making` from `duty_type`

**Confirmed: parsing sessions are making things worse.**

The taxa stage in `staged_parser.ex` internally derives `is_making` from `duty_type` (line 1239: `is_making = "Duty" in duty_types or "Responsibility" in duty_types`) but only uses it locally for LAT/POPIMAR decisions. **It does not include `is_making` in the stage result data.** The chain:

1. Taxa stage returns `duty_type: ["Duty", "Responsibility", ...]` but NOT `is_making`
2. `ParsedLaw.merge` merges taxa results â†’ `is_making` stays `nil`
3. Persister calls `FunctionCalculator.calculate_immediate_function_of_law(record)`
4. FunctionCalculator reads `record.is_making` â†’ `nil` â†’ does NOT add "Making" to function map
5. Result: law has `duty_type` with duties but `is_making=false` and `function` missing "Making"

**148 broken records in DB** where `duty_type` has Duty/Responsibility but `is_making != true`:
- Jan 20: 1 record
- Jan 27-29: 4 records
- **Feb 4-5: 143 records** (bulk from FunctionCalculator batch)

**Fix applied** (3 files changed, all tests pass):

1. `backend/lib/sertantai_legal/scraper/taxa_parser.ex`:
   - `classify_text` return map: added `is_making: is_making_law?(record)`
   - `classify_text_chunked` return map: added `is_making: is_making_law?(merged_record)`
   - `empty_result`: added `is_making: false`
   - `@type taxa_result`: added `is_making: boolean()`

2. `backend/lib/sertantai_legal/scraper/persister.ex`:
   - `update_record_with_immediate_function`: added explicit `is_making` update bypass of `filter_update_attrs` (which skips non-nil values, so `false` â†’ `true` would otherwise be filtered out)

Note: `is_commencing` is NOT derived by taxa â€” it's a separate workflow not yet codified.

### Migration Path

1. ~~**Fix `docs/FUNCTION_VALUES.md`**~~ â€” **DONE** â€” added 3 Maker variants (Amending Maker, Revoking Maker, Enacting Maker), corrected `function` from "JSONB array" to JSONB map, corrected `is_making`/`is_commencing` from decimal to boolean, added Airtable statistics, added Maker qualifier explanation
2. ~~**Ensure CSV updater has run**~~ â€” **DONE** â€” created `scripts/data/import_function_from_csv.exs` (surgical importer with compare-before-update). Dry-run confirmed all 12,858 records already correct JSONB. 229 records have `is_making=NULL` (no CSV Function data). 2 CSV records not in DB (`UK_eudr_2013_0051`, `UK_uksi_1985_612`)
3. **Fix 148 broken records** from old taxa parser (duty_type has Duty/Responsibility but is_making != true):
   - 103 records: `function=NULL`, `is_making=NULL`
   - 21 records: `function=NULL`, `is_making=false`
   - 24 records: `function` has tags (Amending etc.) but missing "Making", `is_making=false`
   - All need: `is_making=true` + `"Making": true` added to function map
   - ~~**Options**: (a) direct SQL update~~ â€” **DONE** via 3 SQL statements:
     1. `SET is_making = true` for 148 records â†’ UPDATE 148
     2. `SET function = function || '{"Making": true}'` for 24 with existing tags â†’ UPDATE 24
     3. `SET function = '{"Making": true}'` for 124 with NULL function â†’ UPDATE 124
   - **Verified**: all 3,150 duty_type Duty/Responsibility records now have `is_making=true` AND `function ? 'Making'`. Zero orphans.
4. **For remaining empty-function records**: run FunctionCalculator to derive from relationship arrays where possible; remainder stays null
4. **For ~484 orphan records**: investigate name mismatches between CSV and DB; fix or derive
5. **Add DB constraint or Ash changeset validation** ensuring `function` is JSONB map (not bare TEXT) and `is_making`/`is_commencing` are boolean
6. ~~**Deprecate `import_uk_lrt.sql`**~~ â€” **DONE** â€” Updated CLAUDE.md, docker-restart SKILL.md, electric-sql SKILLS.md, QUICKSTART.md. SQL dump is now documented as "legacy base import" requiring CSV enrichment step. Files updated:
   - `CLAUDE.md`: two-step import (SQL base + CSV enrichment), data import table marks SQL as legacy, CSV as canonical
   - `.claude/skills/docker-restart/SKILL.md`: data recovery section updated
   - `.claude/skills/electric-sql-management/SKILLS.md`: data recovery section updated
   - `docs/QUICKSTART.md`: data files section updated
7. **Update Ash resource** if needed to enforce JSONB map type on `function`

---

## Item 2: `purpose` and `duty_type` (the Airtable combined field)

### Background

The Airtable `duty_type` column was a combined multi-select mixing two taxonomies:
- **Obligation tags** (WHO): Duty, Right, Responsibility, Power
- **Purpose tags** (WHAT): Amendment, Interpretation+Definition, etc.

These are stored in separate DB columns: `duty_type` (obligations only) and `purpose` (purpose only).

### Desired Schema (from `docs/LRT-SCHEMA.md`)

| Column | Type | Has Data | Format | Stage |
|--------|------|:--------:|--------|-------|
| `purpose` | `map` (JSONB) | No (listed) | `{"values": ["Amendment", ...]}` | ðŸ¦‹_taxa |
| `duty_type` | `map` (JSONB) | Yes (7775) | `{"values": ["Duty", "Responsibility"]}` | ðŸ¦‹_taxa |

Note: LRT-SCHEMA.md says purpose has "No" data but it actually has 8,060 records.

### Current State of Data in DB (verified 2026-02-24)

| Category | Count |
|----------|-------|
| Both `purpose` and `duty_type` | 3,305 |
| `purpose` only | 4,755 |
| Neither | 11,258 |
| `duty_type` only | 0 |

**`duty_type`** â€” clean, only 4 valid values:
- Duty, Right, Responsibility, Power
- Format: `{"values": ["Duty", "Right", ...]}`

**`purpose`** â€” clean, 15 valid values (all `+` separator format):
- Enactment+Citation+Commencement, Interpretation+Definition, Application+Scope, Extent, Exemption, Process+Rule+Constraint+Condition, Power Conferred, Charge+Fee, Offence, Enforcement+Prosecution, Defence+Appeal, Liability, Repeal+Revocation, Amendment, Transitional Arrangement
- Format: `{"values": ["Amendment", "Interpretation+Definition", ...]}`

### Taxa Parser Assessment: ALIGNS CORRECTLY

Taxa parser writes both columns correctly:
- `PurposeClassifier` â†’ `purpose` with `+` separator format, 15 categories
- `DutyType` classifier â†’ `duty_type` with only 4 obligation types
- Both wrapped as `{"values": [...]}` by `ParsedLaw.to_db_attrs`
- No cross-contamination between the two classifiers
- **Parsing sessions do NOT make things worse for purpose/duty_type**

Note: `Liability` is generated by PurposeClassifier but was not in the original Airtable taxonomy â€” it's a new detection category added by the parser.

### Created: `docs/PURPOSE_VALUES.md`

Documents all 15 purpose values, 4 duty_type values, origin from Airtable combined field, and the separation logic.

### Remaining issue

~~`docs/LRT-SCHEMA.md` says purpose has "No" data~~ â€” Already shows "Yes (8060)" in current schema.

---

## Item 3: Holder Fields (`duty_holder`, `rights_holder`, `responsibility_holder`, `power_holder`)

### Background: "Three Conflicting Vocabularies" â€” Actually ONE Vocabulary

Issue #24 assumed three conflicting vocabularies. Investigation shows this is **not the case** for holders:

1. **Airtable CSV** uses prefixed taxonomy: `Ind: Person`, `Org: Employer`, `Gvt: Minister`, etc.
2. **Taxa parser (`actor_definitions.ex`)** uses the **exact same** prefixed taxonomy
3. **SQL dump** has **NULL holders** â€” the dump never carried holder data

The taxa parser was built to replicate the Airtable vocabulary. There is no vocabulary conflict.

### Desired Schema (from `docs/LRT-SCHEMA.md`)

| Column | Type | Has Data | Format | Stage |
|--------|------|:--------:|--------|-------|
| `duty_holder` | `map` (JSONB) | Yes (2606) | `{"Ind: Person": true, "Org: Employer": true}` | ðŸ¦‹_taxa |
| `rights_holder` | `map` (JSONB) | Yes (1943) | `{"Ind: Person": true}` | ðŸ¦‹_taxa |
| `responsibility_holder` | `map` (JSONB) | Yes (2652) | `{"Gvt: Minister": true}` | ðŸ¦‹_taxa |
| `power_holder` | `map` (JSONB) | Yes (2244) | `{"Gvt: Minister": true}` | ðŸ¦‹_taxa |

Also 4 consolidated DRRP JSONB columns (`duties`, `rights`, `responsibilities`, `powers`) with `holders` arrays â€” populated by taxa parser.

### Current State of Data in DB (verified 2026-02-24)

**Coverage:**
- 3,305 records have at least one holder field populated
- 16,013 records have NO holder data at all

**Data sources by date:**

| Updated | Holder Records | Source |
|---------|----------------|--------|
| Jan 17 | 2,243 | CSV import (`update_uk_lrt_taxa.exs`) â€” confirmed 100% match |
| Jan 27-29 | 6 | Taxa parser (small parse batches) |
| Feb 4-5 | 356 | Mixed: 176 CSV-preserved, 29 taxa-extended, 66 taxa-added (empty CSV), 85 new laws |

**Key finding: taxa parser EXTENDS, never REPLACES.** The 29 "extended" records have DB tags that are a strict superset of the CSV tags (29/29 confirmed). The `filter_update_attrs` in persister.ex normally blocks updates to non-nil holder fields, so these 29 are likely records that were re-parsed from scratch (freshly created in Feb, never had CSV holders applied).

### Vocabulary Comparison

**Airtable CSV**: 117 distinct holder tags
**DB**: 121 distinct holder tags (4 extras from taxa parser)
**actor_definitions.ex**: 125 distinct tags defined

| Comparison | Count | Tags |
|------------|-------|------|
| In DB but NOT in CSV | 4 | `Gvt: Authority: Planning`, `Gvt: Ministry: Dept of Enterprise...`, `Org: Investor`, `SC: Keeper` |
| In CSV but NOT in DB | 0 | â€” |
| In code but NOT in CSV | 16 | 5x `Env:` tags, `Gvt: Agency: Office for Environmental Protection`, `HM Forces: Navy`, `Org: Investor`, `SC: C: Constructor`, `SC: Keeper`, `SC: Storer`, `SC: T&L: Handler`, `Spc: Technician`, `Svc: Repairer`, `Gvt: Authority: Planning`, `Gvt: Ministry: Dept of Enterprise...` |
| In CSV but NOT in code | 3 | `Ind: Dutyholder` (variant of `Ind: Duty Holder`), `Organisation`, `Parents` |

**The 16 code-only tags** are new actor types the taxa parser can detect that weren't in the original Airtable taxonomy. These are additive â€” they appear in newly parsed laws.

**The 3 CSV-only tags** are legacy Airtable values not defined as regex patterns:
- `Ind: Dutyholder` â€” duplicate of `Ind: Duty Holder` (different spelling)
- `Organisation` â€” the regex pattern exists but uses atom key `:Organisation` not string
- `Parents` â€” similar to `Public: Parents` but without prefix

### Holder vs Consolidated DRRP Comparison

| Metric | Count |
|--------|-------|
| Both `duty_holder` and `duties` | 2,565 |
| `duty_holder` only (no consolidated) | 41 |
| `duties` only (no simple holder) | 0 |
| Matching holder keys | 2,426 |
| Mismatched (holder superset of consolidated) | 126 |
| Mismatched (consolidated has extras) | 13 |

The simple holder maps (`duty_holder`) are the **union of all actors** found across all articles. The consolidated `duties.holders` array only includes actors found in **Duty-classified articles**. So the simple map is typically a superset.

### Data Quality Issues

1. **Broken CSV split**: `"Gvt: Ministry: Department of Enterprise` and `Trade and Investment"` â€” the comma in the ministry name causes CSV parsing to split into two broken tags (7 records in responsibility_holder, 2 in power_holder)
2. **Duplicate**: `Ind: Dutyholder` vs `Ind: Duty Holder` (both exist in DB, 2 vs 17 records)
3. **Missing prefix**: `Parents` (2 records) should be `Public: Parents`
4. **13 records** where consolidated `duties.holders` has tags NOT in `duty_holder` â€” likely edge case in taxa parser article-level classification

### Taxa Parser Assessment: ALIGNS CORRECTLY

- Taxa parser uses the **same Airtable prefixed vocabulary** (built from `actor_definitions.ex`)
- Holder data format is identical: `{"tag": true, ...}` JSONB maps
- Taxa parser adds 16 new tag types not in Airtable â€” these are **additive enhancements**, not conflicts
- `filter_update_attrs` prevents taxa from overwriting existing CSV holder data
- **Parsing sessions do NOT make things worse for holders**

### No Migration Needed

Unlike `function` (Item 1) which had format issues and a bug, the holder fields are clean:
- No TEXT/JSONB format mismatch
- No conflicting vocabularies
- Both CSV and taxa parser write the same format
- SQL dump contributed NULL (no stale data to clean)

### Remaining work for holders (tracked in separate issues)

- **Issue #26**: Fix 3 data quality issues (13 records) â€” broken CSV split, duplicate spelling, missing prefix
- **Issue #27**: Sync production DB with all dev data fixes (includes holder fixes)
- ~~Create `docs/HOLDER_VALUES.md`~~ â€” **DONE** (121 tags documented with counts, prefix taxonomy, data quality notes)

**Ended**: 2026-02-24 18:05
