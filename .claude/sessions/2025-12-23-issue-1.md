# Issue #1: Port Amend.workflow() - amendment relationships (BFS traversal)

**Started**: 2025-12-23 ~18:45
**Issue**: https://github.com/shotleybuilder/sertantai-legal/issues/1

## Todo
- [x] Review legacy amend.ex and amending.ex in legl donor
- [x] Create Scraper.Amending module for "laws this law amends"
- [x] Parse amendment HTML from legislation.gov.uk
- [x] Wire into staged_parser enrichment pipeline
- [x] Add tests with HTML fixtures
- [x] Fix Function section in ParseReviewModal (function, amending, amended_by, etc.)
- [x] Design cascade update strategy (documented in `docs/AMENDING.md`)
- [x] Implement cascade update:
  - Batch persist collects all affected laws into session JSON
  - Modal shows aggregated affected laws (in DB / not in DB)
  - "Re-parse All In DB" batch updates amended_by via enrichment parse
  - "Scrape & Add Selected" creates new batch â†’ next cascade layer
  - User decides break point between layers
- [x] Flatten stats in staged_parser for UI display

## Notes
- Donor: `~/Desktop/legl/legl/lib/legl/countries/uk/legl_register/amend/`
- See also: `docs/AMENDING.md`
- BFS complexity may be overkill - start simple with enumeration_limit=0

## Work Completed

### Amending Module
- Created `backend/lib/sertantai_legal/scraper/amending.ex`
- Fetches amendment data from `/changes/affecting` and `/changes/affected` endpoints
- Parses HTML tables using Floki
- Separates amendments from revocations
- Returns structured data: amending, rescinding, amended_by, rescinded_by, stats

### Staged Parser Integration
- Updated `staged_parser.ex` Stage 3 to use new Amending module
- Returns: amending, rescinding, amended_by, rescinded_by lists
- Flags: is_amending, is_rescinding
- Counts: amending_count, rescinding_count, amended_by_count, rescinded_by_count
- Stats: amending_stats, amended_by_stats

### ParseReviewModal Updates
- Fixed Function section to display new amendment fields
- Shows badges for "Amending Law" and "Rescinding Law"
- Shows law counts with first 5 names for each relationship

### Tests
- Created `test/sertantai_legal/scraper/amending_test.exs` (18 tests)
- Created HTML fixture `test/fixtures/legislation_gov_uk/amendments_affecting.html`

### Documentation
- Updated `docs/AMENDING.md` with cascade update strategy

## Migration: New Amendment Stats Columns

### Existing Columns (already in uk_lrt)
```
amending              text[]      # Laws this law amends
amended_by            text[]      # Laws that amend this law
rescinding            text[]      # Laws this law revokes
rescinded_by          text[]      # Laws that revoke this law
is_amending           boolean     # True if law amends other laws
is_rescinding         boolean     # True if law revokes other laws
linked_amending       text[]      # Same as amending, populated when target exists in DB
linked_amended_by     text[]      # Same as amended_by, populated when source exists in DB
linked_rescinding     text[]      # Same as rescinding, populated when target exists in DB
linked_rescinded_by   text[]      # Same as rescinded_by, populated when source exists in DB
latest_amend_date     date        # Most recent amendment date
latest_rescind_date   date        # Most recent revocation date
```

### New Columns Needed (from Airtable CSV)

**ðŸ”ºðŸ”» Self-affects** (shared stat):
| Column | Type | Description |
|--------|------|-------------|
| ðŸ”ºðŸ”»_stats_self_affects_count | integer | Amendments this law makes to itself |

**ðŸ”º Amending Stats** (this law affects others):
| Column | Type | Description |
|--------|------|-------------|
| ðŸ”º_stats_affects_count | integer | Total number of amendments made by this law |
| ðŸ”º_stats_affected_laws_count | integer | Distinct laws amended |
| ðŸ”º_stats_affects_count_per_law | text | Summary: "UK_uksi_2020_100 - 3" |
| ðŸ”º_stats_affects_count_per_law_detailed | text | Detailed breakdown with sections |

**ðŸ”» Amended_by Stats** (this law is affected by others):
| Column | Type | Description |
|--------|------|-------------|
| ðŸ”»_stats_affected_by_count | integer | Total amendments made to this law |
| ðŸ”»_stats_affected_by_laws_count | integer | Distinct laws amending this |
| ðŸ”»_stats_affected_by_count_per_law | text | Summary list |
| ðŸ”»_stats_affected_by_count_per_law_detailed | text | Detailed breakdown |

**ðŸ”º Rescinding Stats** (this law rescinds/revokes others):
| Column | Type | Description |
|--------|------|-------------|
| ðŸ”º_stats_rescinding_laws_count | integer | Distinct laws rescinded |
| ðŸ”º_stats_rescinding_count_per_law | text | Summary list |
| ðŸ”º_stats_rescinding_count_per_law_detailed | text | Detailed breakdown |

**ðŸ”» Rescinded_by Stats** (this law is rescinded/revoked by others):
| Column | Type | Description |
|--------|------|-------------|
| ðŸ”»_stats_rescinded_by_laws_count | integer | Distinct laws rescinding this |
| ðŸ”»_stats_rescinded_by_count_per_law | text | Summary list |
| ðŸ”»_stats_rescinded_by_count_per_law_detailed | text | Detailed breakdown |

**Change Logs**:
| Column | Type | Description |
|--------|------|-------------|
| amending_change_log | text | History of amending field changes |
| amended_by_change_log | text | History of amended_by field changes |

### Column Naming Note
- Airtable uses "Revoking" / "Revoked_by"
- Our code uses "rescinding" / "rescinded_by"
- Decision: Use rescinding/rescinded_by in new columns (consistent with existing schema)
- Merged self-affects columns (same value) into single ðŸ”ºðŸ”»_stats_self_affects_count

### Total New Columns: 16
- 1 shared stat
- 4 amending stats
- 4 amended_by stats
- 3 rescinding stats
- 3 rescinded_by stats
- 2 change logs

### Migration & Import Status: COMPLETE
- Migration: `20251223162440_add_amendment_stats_columns.exs`
- Import script: `scripts/update_uk_lrt_amending.exs`
- Import results (2025-12-23):
  - amending: 9,865 records
  - amended_by: 6,338 records
  - rescinding: 2,458 records
  - rescinded_by: 5,789 records
  - stats columns: ~15,000+ records

### Stats Flattening in Staged Parser (2025-12-23)
- **Commit**: `e45d70f` - fix: Flatten amendment stats in staged_parser for UI display
- **Problem**: staged_parser returned nested `amending_stats` map but UI expected flattened keys
- **Solution**: Updated `run_amendments_stage` to return flattened keys matching Ash attributes:
  - `stats_self_affects_count`
  - `amending_stats_affects_count`, `amending_stats_affected_laws_count`
  - `amending_stats_affects_count_per_law`, `amending_stats_affects_count_per_law_detailed`
  - `amended_by_stats_affected_by_count`, `amended_by_stats_affected_by_laws_count`
  - `amended_by_stats_affected_by_count_per_law`, `amended_by_stats_affected_by_count_per_law_detailed`
  - `rescinding_stats_rescinding_laws_count`
  - `rescinding_stats_rescinding_count_per_law`, `rescinding_stats_rescinding_count_per_law_detailed`
  - `rescinded_by_stats_rescinded_by_laws_count`
  - `rescinded_by_stats_rescinded_by_count_per_law`, `rescinded_by_stats_rescinded_by_count_per_law_detailed`
- Added helper functions: `build_count_per_law_summary/1`, `build_count_per_law_detailed/1`, `group_amendments_by_law/1`
- All 190 tests pass

### Cascade Update Implementation (2025-12-23)

**Backend Changes:**
- Extended `LawParser.build_attrs/2` to persist amending/rescinding fields from StagedParser
- Added `Storage.add_affected_laws/4` to collect affected laws into `affected_laws.json`
- Modified confirm endpoint to call `Storage.add_affected_laws` after persist
- Added new API endpoints:
  - `GET /sessions/:id/affected-laws` - Returns in_db and not_in_db lists
  - `POST /sessions/:id/batch-reparse` - Re-parses affected laws using StagedParser
  - `DELETE /sessions/:id/affected-laws` - Clears JSON after cascade complete
  - `POST /uk-lrt/batch-exists` - Check existence of multiple laws

**Frontend Changes:**
- Created `CascadeUpdateModal.svelte` component
  - Shows summary stats (total affected, in DB, not in DB)
  - Lists laws in database with checkboxes for selective re-parse
  - Lists laws not in database (future: option to scrape)
  - "Re-parse Selected" and "Re-parse All" buttons
  - Shows results after re-parse completes
- Wired modal into session page (`/admin/scrape/sessions/[id]`)
  - Modal appears after records are confirmed if there are affected laws
  - Added `getAffectedLaws`, `batchReparse`, `clearAffectedLaws` API functions

**Key Files:**
- `backend/lib/sertantai_legal/scraper/law_parser.ex` - Extended build_attrs
- `backend/lib/sertantai_legal/scraper/storage.ex` - Added affected_laws.json management
- `backend/lib/sertantai_legal_web/controllers/scrape_controller.ex` - New endpoints
- `backend/lib/sertantai_legal_web/controllers/uk_lrt_controller.ex` - batch_exists
- `frontend/src/lib/api/scraper.ts` - Cascade API functions
- `frontend/src/lib/components/CascadeUpdateModal.svelte` - New modal
- `frontend/src/routes/admin/scrape/sessions/[id]/+page.svelte` - Modal integration

**All 272 backend tests pass.**

---

**Ended**: 2025-12-24 ~00:30

## Summary
- Completed: 9 of 9 todos
- Files touched: amending.ex, staged_parser.ex, law_parser.ex, storage.ex, scrape_controller.ex, uk_lrt_controller.ex, CascadeUpdateModal.svelte, ParseReviewModal.svelte
- Outcome: Full cascade update implementation with breadth-first layer processing. GitHub Issue #1 closed.
- Next: None - Issue complete
