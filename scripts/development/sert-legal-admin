#!/bin/bash
# sertantai-legal Admin-Only Development Server
# Starts backend + frontend WITHOUT sertantai-auth dependency.
# Uses GitHub OAuth for admin authentication instead of JWT.
#
# Usage:
#   sert-legal-admin                # Start servers only (assumes Docker running)
#   sert-legal-admin --docker       # Start Docker containers + servers
#   sert-legal-admin --help         # Show this help
#
# Prerequisites:
#   - Set GITHUB_CLIENT_ID and GITHUB_CLIENT_SECRET in .env.dev
#   - Set GITHUB_ALLOWED_USERS to your GitHub username
#   - Create a GitHub OAuth app at: https://github.com/settings/applications/new
#     Homepage URL: http://localhost:4003
#     Callback URL: http://localhost:4003/auth/user/github/callback
#
# Symlink Setup (to run from anywhere):
#   sudo ln -s /path/to/sertantai-legal/scripts/development/sert-legal-admin /usr/local/bin/sert-legal-admin

set -e

# Parse arguments
MANAGE_DOCKER=false
for arg in "$@"; do
    case $arg in
        --docker)
            MANAGE_DOCKER=true
            ;;
        --help|-h)
            head -17 "$0" | tail -15 | sed 's/^# //' | sed 's/^#//'
            exit 0
            ;;
    esac
done

# Resolve symlink to get the actual script path
SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
PROJECT_ROOT="$(cd "$(dirname "$SCRIPT_PATH")/../.." && pwd)"

echo "Starting sertantai-legal in ADMIN-ONLY mode..."
echo "(No sertantai-auth needed — using GitHub OAuth for admin auth)"
echo ""
echo "Project root: $PROJECT_ROOT"
echo ""

# Verify PROJECT_ROOT exists
if [ ! -d "$PROJECT_ROOT" ]; then
    echo "Error: Project root directory not found: $PROJECT_ROOT"
    exit 1
fi

if [ ! -f "$PROJECT_ROOT/backend/mix.exs" ]; then
    echo "Error: mix.exs not found in $PROJECT_ROOT/backend"
    exit 1
fi

# Check if servers are already running
if pgrep -f "mix phx.server.*sertantai_legal" > /dev/null; then
    echo "Warning: Phoenix backend is already running!"
    echo "   Stop it first with: sert-legal-stop"
    exit 1
fi

if lsof -ti:5175 >/dev/null 2>&1; then
    echo "Warning: SvelteKit frontend is already running on port 5175!"
    echo "   Stop it first with: sert-legal-stop"
    exit 1
fi

# Load .env.dev if it exists (for GitHub OAuth credentials)
ENV_FILE="$PROJECT_ROOT/backend/.env.dev"
if [ -f "$ENV_FILE" ]; then
    echo "Loading environment from .env.dev..."
    set -a
    source "$ENV_FILE"
    set +a
fi

# Verify GitHub OAuth is configured
if [ -z "$GITHUB_CLIENT_ID" ] && [ -z "$SERTANTAI_LEGAL_GITHUB_CLIENT_ID" ]; then
    echo ""
    echo "Warning: GITHUB_CLIENT_ID is not set!"
    echo "   GitHub OAuth will not work. Set it in .env.dev or as an environment variable."
    echo "   See: https://github.com/settings/applications/new"
    echo ""
fi

# ============================================================================
# Docker container management
# ============================================================================
if [ "$MANAGE_DOCKER" = true ]; then
    echo "Managing Docker containers..."
    cd "$PROJECT_ROOT"

    NEED_START=false
    if ! docker ps | grep -q "sertantai-legal-postgres"; then
        NEED_START=true
    fi
    if ! docker ps | grep -q "sertantai-legal-electric"; then
        NEED_START=true
    fi

    if [ "$NEED_START" = true ]; then
        echo "   Starting Docker services (postgres + electric)..."
        docker compose -f docker-compose.dev.yml up -d postgres
        echo "   Waiting for postgres to be healthy..."
        sleep 5
        docker compose -f docker-compose.dev.yml up -d --no-deps electric

        echo -n "   Waiting for ElectricSQL..."
        for i in $(seq 1 30); do
            if curl -s -o /dev/null -w "" http://localhost:3002/v1/health 2>/dev/null; then
                echo " ready"
                break
            fi
            if [ "$i" -eq 30 ]; then
                echo " timeout (may still be starting)"
            fi
            sleep 1
            echo -n "."
        done
    else
        echo "   Docker services already running"
    fi
    echo ""
else
    MISSING=""
    if ! docker ps | grep -q "sertantai-legal-postgres"; then
        MISSING="postgres"
    fi
    if ! docker ps | grep -q "sertantai-legal-electric"; then
        if [ -n "$MISSING" ]; then
            MISSING="$MISSING, electric"
        else
            MISSING="electric"
        fi
    fi
    if [ -n "$MISSING" ]; then
        echo "Warning: Docker containers not detected ($MISSING)"
        echo "   Tip: Use 'sert-legal-admin --docker' to auto-start containers"
        echo ""
    fi
fi

# ============================================================================
# Start servers (without AUTH_URL so JwksClient runs in degraded mode)
# ============================================================================
echo "Opening terminal tabs..."

LAUNCHER_SCRIPT=$(mktemp)

cat > "$LAUNCHER_SCRIPT" << LAUNCHER_EOF
#!/bin/bash

PROJECT_ROOT="$PROJECT_ROOT"

# Phoenix backend — unset AUTH_URL for admin-only mode
gnome-terminal --tab --title="legal-admin-backend" --working-directory="\$PROJECT_ROOT/backend" -- bash -c 'echo "Starting Phoenix backend (ADMIN-ONLY mode) on port 4003..."; echo "JWT tenant auth DISABLED (no sertantai-auth)"; echo "GitHub OAuth admin auth ENABLED"; echo ""; unset DATABASE_URL; unset AUTH_URL; mix phx.server; echo ""; echo "Service stopped. Press Enter to close tab..."; read' &
sleep 0.3

# SvelteKit frontend
gnome-terminal --tab --title="legal-admin-frontend" --working-directory="\$PROJECT_ROOT/frontend" -- bash -c 'echo "Starting SvelteKit frontend on port 5175..."; echo ""; npm run dev; echo ""; echo "Service stopped. Press Enter to close tab..."; read' &

wait
LAUNCHER_EOF

chmod +x "$LAUNCHER_SCRIPT"

gnome-terminal --window -- bash -c "$LAUNCHER_SCRIPT; rm -f $LAUNCHER_SCRIPT"

echo ""
echo "Admin-only development servers starting!"
echo ""
echo "URLs:"
echo "   Backend:  http://localhost:4003  (phoenix)"
echo "   Frontend: http://localhost:5175  (svelte)"
echo "   Electric: http://localhost:3002  (sync)"
echo ""
echo "Admin UI: http://localhost:5175/admin"
echo "   Sign in with GitHub to access admin tools."
echo ""
echo "Note: JWT tenant routes will return 401 (no sertantai-auth)."
echo "   To enable full auth, use 'sert-legal-start --auth' instead."
echo ""
echo "To stop: sert-legal-stop"
echo ""
