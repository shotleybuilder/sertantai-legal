#!/bin/bash
# sertantai-legal Development Server Starter
# Starts backend (Phoenix) and frontend (SvelteKit) in terminal tabs
# Optionally manages sertantai-auth dependency service
#
# Usage:
#   sert-legal-start                # Start servers only (assumes Docker already running)
#   sert-legal-start --docker       # Start Docker containers + servers
#   sert-legal-start --auth         # Also ensure sertantai-auth is running
#   sert-legal-start --zenoh        # Enable Zenoh P2P mesh (taxa subscriber, data server)
#   sert-legal-start --docker --auth # Start everything including auth
#
# Symlink Setup (to run from anywhere):
#   sudo ln -s /home/jason/Desktop/sertantai-legal/scripts/development/sert-legal-start /usr/local/bin/sert-legal-start

set -e

# Parse arguments
MANAGE_DOCKER=false
MANAGE_AUTH=false
ENABLE_ZENOH=false
for arg in "$@"; do
    case $arg in
        --docker)
            MANAGE_DOCKER=true
            ;;
        --auth)
            MANAGE_AUTH=true
            ;;
        --zenoh)
            ENABLE_ZENOH=true
            ;;
    esac
done

# Resolve symlink to get the actual script path
SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
PROJECT_ROOT="$(cd "$(dirname "$SCRIPT_PATH")/../.." && pwd)"

# sertantai-auth project location
AUTH_PROJECT_ROOT="$HOME/Desktop/sertantai_auth"
AUTH_PORT=4000
AUTH_DB_PORT=5435

echo "Starting sertantai-legal development servers..."
echo "Project root: $PROJECT_ROOT"
echo "Frontend dir: $PROJECT_ROOT/frontend"
echo ""

# Verify PROJECT_ROOT exists
if [ ! -d "$PROJECT_ROOT" ]; then
    echo "Error: Project root directory not found: $PROJECT_ROOT"
    exit 1
fi

if [ ! -f "$PROJECT_ROOT/backend/mix.exs" ]; then
    echo "Error: mix.exs not found in $PROJECT_ROOT/backend"
    exit 1
fi

# Check if servers are already running
if pgrep -f "mix phx.server.*sertantai_legal" > /dev/null; then
    echo "Warning: Phoenix backend is already running!"
    echo "   Stop it first with: sert-legal-stop"
    exit 1
fi

if lsof -ti:5175 >/dev/null 2>&1; then
    echo "Warning: SvelteKit frontend is already running on port 5175!"
    echo "   Stop it first with: sert-legal-stop"
    exit 1
fi

# ============================================================================
# sertantai-auth dependency management
# ============================================================================
check_auth_running() {
    curl -s -o /dev/null -w "%{http_code}" "http://localhost:$AUTH_PORT/health" 2>/dev/null | grep -q "200"
}

if [ "$MANAGE_AUTH" = true ]; then
    echo "Checking sertantai-auth service..."

    if [ ! -d "$AUTH_PROJECT_ROOT" ]; then
        echo "Error: sertantai-auth project not found at $AUTH_PROJECT_ROOT"
        exit 1
    fi

    if check_auth_running; then
        echo "   sertantai-auth already running on port $AUTH_PORT"
    else
        echo "   sertantai-auth not running, starting it..."

        # Check/start auth postgres container
        if ! docker ps --format '{{.Names}}' | grep -q "sertantai-auth.*postgres\|sertantai_auth.*postgres"; then
            echo "   Starting sertantai-auth PostgreSQL (port $AUTH_DB_PORT)..."
            cd "$AUTH_PROJECT_ROOT"
            docker compose -f docker-compose.dev.yml up -d postgres
            echo -n "   Waiting for auth postgres..."
            for i in $(seq 1 15); do
                if docker compose -f docker-compose.dev.yml exec -T postgres pg_isready -U postgres >/dev/null 2>&1; then
                    echo " ready"
                    break
                fi
                if [ "$i" -eq 15 ]; then
                    echo " timeout (may still be starting)"
                fi
                sleep 1
                echo -n "."
            done
            cd "$PROJECT_ROOT"
        else
            echo "   sertantai-auth PostgreSQL already running"
        fi

        # Start auth Phoenix server in a terminal tab
        echo "   Starting sertantai-auth Phoenix server (port $AUTH_PORT)..."
        gnome-terminal --tab --title="sertantai-auth-backend" --working-directory="$AUTH_PROJECT_ROOT" -- bash -c "echo 'Starting sertantai-auth on port $AUTH_PORT...'; echo 'Working directory: \$(pwd)'; echo ''; unset DATABASE_URL; mix phx.server; echo ''; echo 'Service stopped. Press Enter to close tab...'; read" &

        # Wait for auth to be healthy
        echo -n "   Waiting for sertantai-auth to be ready..."
        for i in $(seq 1 30); do
            if check_auth_running; then
                echo " ready"
                break
            fi
            if [ "$i" -eq 30 ]; then
                echo " timeout (may still be starting)"
            fi
            sleep 1
            echo -n "."
        done
    fi
    echo ""
else
    # Check if auth is running (informational)
    if check_auth_running; then
        echo "sertantai-auth: running on port $AUTH_PORT"
    else
        echo "Note: sertantai-auth not running (port $AUTH_PORT)"
        echo "   Tip: Use '--auth' flag to auto-start it"
    fi
    echo ""
fi

# ============================================================================
# Docker container management (sertantai-legal)
# ============================================================================
if [ "$MANAGE_DOCKER" = true ]; then
    echo "Managing Docker containers..."
    cd "$PROJECT_ROOT"

    NEED_START=false
    if ! docker ps | grep -q "sertantai-legal-postgres"; then
        NEED_START=true
    fi
    if ! docker ps | grep -q "sertantai-legal-electric"; then
        NEED_START=true
    fi

    if [ "$NEED_START" = true ]; then
        echo "   Starting Docker services (postgres + electric)..."
        # Start postgres first, then electric with --no-deps to avoid
        # dependency chain recreating postgres (see SKILLS.md)
        docker compose -f docker-compose.dev.yml up -d postgres
        echo "   Waiting for postgres to be healthy..."
        sleep 5
        docker compose -f docker-compose.dev.yml up -d --no-deps electric

        # Wait for Electric to be ready (up to 30s)
        echo -n "   Waiting for ElectricSQL..."
        for i in $(seq 1 30); do
            if curl -s -o /dev/null -w "" http://localhost:3002/v1/health 2>/dev/null; then
                echo " ready"
                break
            fi
            if [ "$i" -eq 30 ]; then
                echo " timeout (may still be starting)"
            fi
            sleep 1
            echo -n "."
        done
    else
        echo "   Docker services already running"
    fi
    echo ""
else
    # Check if Docker services are running (warning only)
    MISSING=""
    if ! docker ps | grep -q "sertantai-legal-postgres"; then
        MISSING="postgres"
    fi
    if ! docker ps | grep -q "sertantai-legal-electric"; then
        if [ -n "$MISSING" ]; then
            MISSING="$MISSING, electric"
        else
            MISSING="electric"
        fi
    fi
    if [ -n "$MISSING" ]; then
        echo "Warning: Docker containers not detected ($MISSING)"
        echo "   Tip: Use 'sert-legal-start --docker' to auto-start containers"
        echo ""
    fi
fi

# ============================================================================
# Start sertantai-legal servers
# ============================================================================
echo "Opening terminal tabs..."

# Create a temporary launcher script
LAUNCHER_SCRIPT=$(mktemp)

cat > "$LAUNCHER_SCRIPT" << 'LAUNCHER_EOF'
#!/bin/bash

PROJECT_ROOT="__PROJECT_ROOT__"

# Open Phoenix backend tab
gnome-terminal --tab --title="sertantai-legal-backend" --working-directory="$PROJECT_ROOT/backend" -- bash -c 'echo "Starting Phoenix backend on port 4003..."; echo "Working directory: $(pwd)"; __ZENOH_ECHO__echo ""; unset DATABASE_URL; __ZENOH_ENV__mix phx.server; echo ""; echo "Service stopped. Press Enter to close tab..."; read' &
sleep 0.3

# Open SvelteKit frontend tab
gnome-terminal --tab --title="sertantai-legal-frontend" --working-directory="$PROJECT_ROOT/frontend" -- bash -c 'echo "Starting SvelteKit frontend on port 5175..."; echo "Working directory: $(pwd)"; echo ""; npm run dev; echo ""; echo "Service stopped. Press Enter to close tab..."; read' &

# Wait for all background processes
wait
LAUNCHER_EOF

# Replace placeholders
sed -i "s|__PROJECT_ROOT__|$PROJECT_ROOT|g" "$LAUNCHER_SCRIPT"
if [ "$ENABLE_ZENOH" = true ]; then
    sed -i 's|__ZENOH_ENV__|ZENOH_ENABLED=true ZENOH_TENANT=dev |g' "$LAUNCHER_SCRIPT"
    sed -i 's|__ZENOH_ECHO__|echo "Zenoh P2P: enabled"; |g' "$LAUNCHER_SCRIPT"
else
    sed -i 's|__ZENOH_ENV__||g' "$LAUNCHER_SCRIPT"
    sed -i 's|__ZENOH_ECHO__||g' "$LAUNCHER_SCRIPT"
fi
chmod +x "$LAUNCHER_SCRIPT"

# Execute the launcher script in a new gnome-terminal window
gnome-terminal --window -- bash -c "$LAUNCHER_SCRIPT; rm -f $LAUNCHER_SCRIPT"

echo ""
echo "Development servers starting in terminal tabs!"
echo ""
echo "URLs:"
echo "   Backend:  http://localhost:4003  (phoenix)"
echo "   Frontend: http://localhost:5175  (svelte)"
echo "   Electric: http://localhost:3002  (sync)"
if [ "$MANAGE_AUTH" = true ] || check_auth_running 2>/dev/null; then
    echo "   Auth:     http://localhost:$AUTH_PORT  (sertantai-auth)"
fi
if [ "$ENABLE_ZENOH" = true ]; then
    echo "   Zenoh:    enabled (tenant=dev, multicast scouting)"
fi
echo ""
echo "To stop: sert-legal-stop"
echo ""
